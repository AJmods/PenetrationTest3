<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <header>
        <h1>Welcome, {{ username }}!</h1>
        <div class="top-buttons">
            <a href="{{ url_for('profile') }}" class="btn">Profile</a>
            <a href="{{ url_for('history') }}" class="btn">History</a>
            <a href="{{ url_for('logout') }}" class="btn">Logout</a>
        </div>
    </header>

    <!-- File Upload Section -->
    <section class="file-upload-section">
        <h2>Upload Pentest Report</h2>
        <div id="drop-area">
            <form id="upload-form" class="upload-form" action="{{ url_for('upload_file') }}" method="POST" enctype="multipart/form-data">
                <input type="file" id="fileElem" name="pentest_file" accept=".txt,.pdf,.xml,.html" onchange="handleFiles(this.files)">
                <label class="file-drop-label" for="fileElem">Drag & Drop your file here or click to select</label>
                <button id="uploadBtn" type="submit" class="submit-btn" disabled>Upload and Analyze</button>
            </form>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" style="display: none;">
            <div id="progress-bar">
                <div id="progress-fill"></div>
            </div>
            <p id="time-remaining"></p>
        </div>
    </section>

    <!-- CVE Results Section -->
    <section class="cve-results" style="display: none;">
        <h2>Extracted CVEs</h2>
        <ul id="cve-list"></ul>
    </section>

    <!-- Vulnerabilities Section -->
    <section id="vulnerabilities" style="display: none;"></section>

    <script>
        let uploadForm = document.getElementById("upload-form");
        let uploadBtn = document.getElementById("uploadBtn");
        let progressContainer = document.getElementById("progress-container");
        let progressFill = document.getElementById("progress-fill");
        let timeRemaining = document.getElementById("time-remaining");
        let cveResultsSection = document.querySelector('.cve-results');

        let startTime;
        let totalSize;

        function handleFiles(files) {
            uploadBtn.disabled = false;  // Enable button when file is selected
        }

        uploadForm.addEventListener('submit', function (event) {
            event.preventDefault();
            uploadBtn.disabled = true;

            let fileElem = document.getElementById("fileElem").files[0];
            if (!fileElem) {
                return;
            }

            totalSize = fileElem.size;
            startTime = new Date().getTime();

            let formData = new FormData(uploadForm);
            progressContainer.style.display = "block";

            let xhr = new XMLHttpRequest();
            xhr.open("POST", uploadForm.action, true);

            xhr.upload.onprogress = function (event) {
                let percentComplete = Math.round((event.loaded / event.total) * 100);
                progressFill.style.width = percentComplete + "%";

                // Calculate remaining time
                let elapsedTime = (new Date().getTime() - startTime) / 1000; // seconds
                let uploadSpeed = event.loaded / elapsedTime; // bytes per second
                let remainingTime = (totalSize - event.loaded) / uploadSpeed; // seconds remaining
                timeRemaining.textContent = `Time remaining: ${Math.round(remainingTime)} seconds`;
            };

            xhr.onload = function () {
                progressFill.style.width = "100%";
                timeRemaining.textContent = "Upload complete!";

                // Try to parse the response as JSON
                try {
                    let responseData = JSON.parse(xhr.responseText);
                    if (responseData.cves) {
                        displayResults(responseData.cves);
                    }
                } catch (error) {
                    console.error('Failed to parse JSON response:', error);
                    timeRemaining.textContent = "Error parsing server response.";
                }
            };

            xhr.onerror = function () {
                timeRemaining.textContent = "Upload failed!";
            };

            xhr.send(formData);
        });

        function displayResults(cves) {
            // Show the CVE results section
            cveResultsSection.style.display = "block";
            let cveList = document.getElementById('cve-list');
            cveList.innerHTML = '';

            cves.forEach(function (cve) {
                cveList.innerHTML += `<li>${cve.id}: ${cve.description} (Category: ${cve.category})</li>`;
            });
        }

        // Fetch vulnerability data for a report (report ID is hardcoded as 1 for this example)
        fetch('/report/1')  // Replace 1 with the actual report ID
            .then(response => response.json())
            .then(data => {
                const vulnerabilitiesDiv = document.getElementById('vulnerabilities');
                data.forEach(vulnerability => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-header">${vulnerability.cve} - Severity: ${vulnerability.severity}</div>
                        <div class="card-body">
                            <p><strong>Name:</strong> ${vulnerability.name}</p>
                            <p><strong>Description:</strong> ${vulnerability.description}</p>
                            <p><strong>Risk Estimation:</strong> ${vulnerability.risk_estimation}</p>
                            <p><strong>Cost to Fix:</strong> ${vulnerability.low_cost} - ${vulnerability.high_cost}</p>
                            <p><strong>Time to Fix:</strong> ${vulnerability.time_to_fix}</p>
                        </div>
                    `;
                    vulnerabilitiesDiv.appendChild(card);
                });
                vulnerabilitiesDiv.style.display = 'block'; // Show the vulnerabilities section
            })
            .catch(error => console.error('Error fetching vulnerabilities:', error));
    </script>
</body>
</html>
